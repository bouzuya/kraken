var AtomBuilder,AtomFormatter,Compiler,Promise,SitemapBuilder,SitemapFormatter,async,fs,marked,myjekyll,path;Promise=require("es6-promise").Promise,fs=require("fs-extra"),marked=require("marked"),myjekyll=require("myjekyll"),path=require("path"),async=require("./async"),AtomBuilder=require("./atom-builder"),AtomFormatter=require("./atom-formatter"),SitemapBuilder=require("./sitemap-builder"),SitemapFormatter=require("./sitemap-formatter"),Compiler=function(){function t(t){var e,i;i=t.postsDir,e=t.dstDir,this._postsDir=i,this._dstDir=e,this._blog={},this._compiledPosts=[]}return t.prototype.compile=function(){return this._blog=myjekyll(this._postsDir+"/**/*.coffee",{}),Promise.resolve().then(this._compilePosts.bind(this)).then(this._writePosts.bind(this)).then(this._writePostsJson.bind(this)).then(this._writeTagsJson.bind(this)).then(this._writeSitemapXml.bind(this)).then(this._writeAtomXml.bind(this))},t.prototype._compilePosts=function(){return this._compiledPosts=this._blog.entries().map(function(t){return{data:t.content,date:t.file.replace(/^(\d{4}-\d{2}-\d{2})-.*$/,"$1"),html:marked(t.content),minutes:t.minutes,pubdate:t.pubdate,tags:t.tags,title:t.title}})},t.prototype._writePosts=function(){var t,e;return e=this._compiledPosts,t=path.join(this._dstDir,"posts"),async.eachSeries(e,function(e){var i;return i=path.join(t,e.date+".join"),fs.outputJsonSync(i,e,{encoding:"utf-8"})})},t.prototype._writePostsJson=function(){var t,e,i;return i=this._compiledPosts,e=path.join(this._dstDir,"posts.json"),t=i.map(function(t){if(null==t.minutes)throw new Error(t.date+" minutes is not defined.");return{date:t.date,minutes:t.minutes,pubdate:t.pubdate,tags:t.tags,title:t.title}}),fs.outputJsonSync(e,t,{encoding:"utf-8"})},t.prototype._writeTagsJson=function(){var t,e,i;return e=path.join(this._dstDir,"tags.json"),i=this._blog.tagCounts(),t=Object.keys(i).reduce(function(t,e){return t.push({name:e,count:i[e]})},[]),fs.outputJsonSync(e,t,{encoding:"utf-8"})},t.prototype._writeSitemapXml=function(){var t,e,i,r;return e=path.join(this._dstDir,"sitemap.xml"),r=new SitemapBuilder(this._compiledPosts).build(),i=new SitemapFormatter(r),t=i.format(),fs.outputFileSync(e,t,{encoding:"utf-8"})},t.prototype._writeAtomXml=function(){var t,e,i,r;return i=path.join(this._dstDir,"atom.xml"),t=new AtomBuilder(this._compiledPosts).build(),r=new AtomFormatter(t),e=r.format(),fs.outputFileSync(i,e,{encoding:"utf-8"})},t}(),module.exports=Compiler;