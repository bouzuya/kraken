var AtomBuilder,AtomFormatter,Compiler,Promise,SitemapBuilder,SitemapFormatter,async,fs,marked,moment,myjekyll,path;Promise=require("es6-promise").Promise,fs=require("fs-extra"),marked=require("marked"),moment=require("moment"),myjekyll=require("myjekyll"),path=require("path"),async=require("./async"),AtomBuilder=require("./atom-builder"),AtomFormatter=require("./atom-formatter"),SitemapBuilder=require("./sitemap-builder"),SitemapFormatter=require("./sitemap-formatter"),Compiler=function(){function t(t){var e,i;i=t.postsDir,e=t.dstDir,this._postsDir=i,this._dstDir=e,this._blog={},this._compiledPosts=[]}return t.prototype.compile=function(){return this._blog=myjekyll(this._postsDir+"/**/*.md",{}),Promise.resolve().then(this._compilePosts.bind(this)).then(this._writeDailyPosts.bind(this)).then(this._writeMonthlyPosts.bind(this)).then(this._writeYearlyPosts.bind(this)).then(this._writeAllPosts.bind(this)).then(this._writeTagsJson.bind(this)).then(this._writeSitemapXml.bind(this)).then(this._writeAtomXml.bind(this))},t.prototype._compilePosts=function(){return this._compiledPosts=this._blog.entries().map(function(t){return{data:t.content,date:t.file.replace(/^(\d{4}-\d{2}-\d{2})-.*$/,"$1"),html:marked(t.content),minutes:t.minutes,pubdate:t.pubdate,tags:t.tags,title:t.title}})},t.prototype._writeDailyPosts=function(){var t,e;return e=this._compiledPosts,t=this._dstDir,async.eachSeries(e,function(e){var i,o,n,r,s;return i=moment(e.date),s=i.format("YYYY"),r=i.format("MM"),o=i.format("DD"),n=path.join(t,s,r,o+".json"),fs.outputJsonSync(n,e,{encoding:"utf-8"}),n=path.join(t,s,r,o,"index.json"),fs.outputJsonSync(n,e,{encoding:"utf-8"})})},t.prototype._writeMonthlyPosts=function(){var t,e,i,o,n,r,s,u,m;o=this._compiledPosts.reduce(function(t,e){var i,o;return i=moment(e.date),o=i.format("YYYY/MM"),null==t[o]&&(t[o]=[]),t[o].push(e),t},{}),e=this._dstDir,s=[];for(m in o)n=o[m],r=m.split("/"),u=r[0],i=r[1],t=path.join(e,u,i+".json"),fs.outputJsonSync(t,n,{encoding:"utf-8"}),t=path.join(e,u,i,"index.json"),s.push(fs.outputJsonSync(t,n,{encoding:"utf-8"}));return s},t.prototype._writeYearlyPosts=function(){var t,e,i,o,n,r;r=this._compiledPosts.reduce(function(t,e){var i,o;return i=moment(e.date),o=i.format("YYYY"),null==t[o]&&(t[o]=[]),t[o].push(e),t},{}),e=this._dstDir,o=[];for(n in r)i=r[n],t=path.join(e,n+".json"),fs.outputJsonSync(t,i,{encoding:"utf-8"}),t=path.join(e,n,"index.json"),o.push(fs.outputJsonSync(t,i,{encoding:"utf-8"}));return o},t.prototype._writeAllPosts=function(){var t,e,i;return i=this._compiledPosts,e=path.join(this._dstDir,"posts.json"),t=i.map(function(t){if(null==t.minutes)throw new Error(t.date+" minutes is not defined.");return{date:t.date,minutes:t.minutes,pubdate:t.pubdate,tags:t.tags,title:t.title}}),fs.outputJsonSync(e,t,{encoding:"utf-8"})},t.prototype._writeTagsJson=function(){var t,e,i;return e=path.join(this._dstDir,"tags.json"),i=this._blog.tagCounts(),t=Object.keys(i).reduce(function(t,e){return t.push({name:e,count:i[e]}),t},[]),fs.outputJsonSync(e,t,{encoding:"utf-8"})},t.prototype._writeSitemapXml=function(){var t,e,i,o;return e=path.join(this._dstDir,"sitemap.xml"),o=new SitemapBuilder(this._compiledPosts).build(),i=new SitemapFormatter(o),t=i.format(),fs.outputFileSync(e,t,{encoding:"utf-8"})},t.prototype._writeAtomXml=function(){var t,e,i,o;return i=path.join(this._dstDir,"atom.xml"),t=new AtomBuilder(this._compiledPosts).build(),o=new AtomFormatter(t),e=o.format(),fs.outputFileSync(i,e,{encoding:"utf-8"})},t}(),module.exports=Compiler;